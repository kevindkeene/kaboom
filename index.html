<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kaboom! - Arcade Edition</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;800;900&display=swap');
        
        body { font-family: 'Inter', sans-serif; background-color: #111827; color: #f9fafb; margin: 0; overflow: hidden; }
        
        #game-area {
            position: relative;
            width: 100%;
            max-width: 400px;
            height: 600px;
            background-size: cover;
            background-repeat: no-repeat;
            border: none; 
            overflow: hidden;
            margin: auto;
            touch-action: none; 
            cursor: crosshair;
        }

        #game-area.hide-pointer { cursor: none !important; }

        .pixel-art {
            image-rendering: pixelated;
            image-rendering: crisp-edges;
        }

        .mad-bomber-img {
            position: absolute;
            top: 0;
            left: 0;
            z-index: 100;
        }

        .bucket-stack {
            position: absolute;
            display: flex;
            flex-direction: column-reverse; 
            align-items: center;
            justify-content: flex-start;
            z-index: 90;
            transition: top 0.2s ease-out;
        }

        .bucket-img { object-fit: contain; width: 100%; height: 100%; }

        .bomb-img { position: absolute; z-index: 50; transition: opacity 0.1s; }
        .splash-img { position: absolute; z-index: 250; pointer-events: none; }
        .explosion-img { position: absolute; z-index: 200; pointer-events: none; }

        .game-status-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(4px);
            z-index: 300;
            transition: opacity 0.3s;
        }

        /* Countdown Number Animation */
        .countdown-number {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 12rem;
            font-weight: 900;
            color: rgba(255, 255, 255, 0.7);
            pointer-events: none;
            z-index: 150;
            line-height: 1;
            animation: countdownScaleFade 0.4s ease-out forwards;
        }

        @keyframes countdownScaleFade {
            0% { transform: translate(-50%, -50%) scale(3); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(0.8); opacity: 0; }
        }

        #preload-cache {
            position: absolute;
            width: 0;
            height: 0;
            overflow: hidden;
            opacity: 0;
            pointer-events: none;
        }
    </style>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- CONSTANTS ---
        const GAME_AREA_WIDTH = 400;
        const GAME_AREA_HEIGHT = 600;
        const INITIAL_BUCKET_COUNT = 3;
        const EXPLOSION_CHAIN_DELAY = 750; 
        
        const THEMES = {
            'classic': {
                title: 'Classic Kaboom',
                description: 'The original bomb-catching challenge.',
                isStacked: true, 
                bomberDim: { w: 21, h: 50 }, 
                bombDim: { w: 15, h: 28 },
                bucketDim: { w: 50, h: 20, gap: 2 },
                splashDim: { w: 33, h: 46 },
                explosionDim: { w: 80, h: 64 }, 
                catchDuration: 780, 
                missDuration: 1240, 
                hitbox: { xOffset: 0, catchW: 50, yOffset: 0, catchH: 20 }, 
                graphics: {
                    BOMBER: 'https://kevindkeene.github.io/kaboom/assets/bomber336x800.gif',
                    BOMB: 'https://kevindkeene.github.io/kaboom/assets/bomb240x448.gif',
                    BUCKET: 'https://kevindkeene.github.io/kaboom/assets/bucket.gif', 
                    EXPLOSION: 'https://kevindkeene.github.io/kaboom/assets/explosion320x256.gif',
                    SPLASH: 'https://kevindkeene.github.io/kaboom/assets/splash264x368.gif',
                    BACKGROUND: 'https://kevindkeene.github.io/kaboom/assets/kaboom-background.gif'
                },
                settings: {
                    EASY: { baseBombSpeed: 2.0, initialDropInterval: 120, initialBomberSpeed: 1.0 },
                    MEDIUM: { baseBombSpeed: 2.5, initialDropInterval: 100, initialBomberSpeed: 1.5 },
                    HARD: { baseBombSpeed: 3.2, initialDropInterval: 70, initialBomberSpeed: 2.0 }
                }
            },
            'alien-drop': {
                title: 'Alien Cow Drop',
                description: 'Catch falling cows on your tractor trailer hay bales!',
                isStacked: false, 
                bomberDim: { w: 50, h: 50 }, 
                bombDim: { w: 32, h: 26 }, 
                bucketDim: { w: 220, h: 80, gap: 0 }, 
                splashDim: { w: 80, h: 80 },
                explosionDim: { w: 80, h: 80 },
                catchDuration: 900, 
                missDuration: 1240, 
                hitboxByLife: [
                    { xOffset: 115, catchW: 100, yOffset: 38, catchH: 18 }, 
                    { xOffset: 115, catchW: 100, yOffset: 19, catchH: 37 }, 
                    { xOffset: 115, catchW: 100, yOffset: 0,  catchH: 56 }  
                ],
                graphics: {
                    BOMBER: 'https://kevindkeene.github.io/kaboom/assets/ufo2-400x400.gif', 
                    BOMB: 'https://kevindkeene.github.io/kaboom/assets/cow3.gif', 
                    BUCKET_LAYERS: [
                        'https://kevindkeene.github.io/kaboom/assets/tractor-0hay.gif',
                        'https://kevindkeene.github.io/kaboom/assets/tractor-1hay.gif',
                        'https://kevindkeene.github.io/kaboom/assets/tractor-2hay.gif',
                        'https://kevindkeene.github.io/kaboom/assets/tractor-3hay.gif'
                    ],
                    EXPLOSION: 'https://kevindkeene.github.io/kaboom/assets/cow3-explode.gif', 
                    SPLASH: 'https://kevindkeene.github.io/kaboom/assets/burst.gif',
                    BACKGROUND: 'https://kevindkeene.github.io/kaboom/assets/alien_background2.gif'
                },
                settings: {
                    EASY: { baseBombSpeed: 2.5, initialDropInterval: 100, initialBomberSpeed: 1.5 },
                    MEDIUM: { baseBombSpeed: 3.0, initialDropInterval: 80, initialBomberSpeed: 2.0 },
                    HARD: { baseBombSpeed: 3.8, initialDropInterval: 60, initialBomberSpeed: 2.5 }
                }
            }
        };

        // --- GAME STATE ---
        let score = 0, lives = INITIAL_BUCKET_COUNT, highscore = 0, level = 1;
        let isGameOver = true, isGamePaused = true, frame = 0;
        let bombs = [], bucketElements = [];
        let currentThemeId = 'classic', currentDifficulty = 'MEDIUM';
        let bucketX = 0, madBomberX = 0, madBomberDirection = 1;
        let speedMultiplier = 1, madBomberSpeed = 1.5;
        let levelCatches = 0, totalCatchesNeeded = 15, bombsDroppedInAttempt = 0;
        let isTransitioningLevel = false;
        
        let lastTapTime = 0; 
        
        let db, auth, userId, highscoreRef, animationFrameHandle;

        function triggerHaptic(pattern) {
            if ("vibrate" in navigator) { navigator.vibrate(pattern); }
        }

        function getCurrentHitbox() {
            const theme = THEMES[currentThemeId];
            if (theme.isStacked) return theme.hitbox;
            return theme.hitboxByLife[Math.max(0, lives - 1)];
        }

        function preloadThemeAssets(themeId) {
            const theme = THEMES[themeId];
            const cache = document.getElementById('preload-cache');
            cache.innerHTML = ''; 
            const assets = [theme.graphics.BOMBER, theme.graphics.BOMB, theme.graphics.EXPLOSION, theme.graphics.SPLASH, theme.graphics.BACKGROUND];
            if (theme.graphics.BUCKET_LAYERS) assets.push(...theme.graphics.BUCKET_LAYERS);
            if (theme.graphics.BUCKET) assets.push(theme.graphics.BUCKET);
            assets.forEach(url => { const img = new Image(); img.src = url; cache.appendChild(img); });
        }

        async function initFirebase() {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const config = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
            if (!config.apiKey) return;
            const app = initializeApp(config);
            db = getFirestore(app);
            auth = getAuth(app);
            onAuthStateChanged(auth, async (u) => {
                if (u) {
                    userId = u.uid;
                    highscoreRef = doc(db, `/artifacts/${appId}/users/${userId}/highscores`, 'kaboom-score');
                    onSnapshot(highscoreRef, (d) => { if (d.exists()) highscore = d.data().score; updateScoreDisplay(); });
                } else {
                    const t = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                    if (t) await signInWithCustomToken(auth, t); else await signInAnonymously(auth);
                }
            });
        }

        function startGame(themeId, diff) {
            isGameOver = false; isGamePaused = false;
            currentThemeId = themeId; currentDifficulty = diff;
            const theme = THEMES[themeId];
            const settings = theme.settings[diff];
            preloadThemeAssets(themeId);
            if (animationFrameHandle) cancelAnimationFrame(animationFrameHandle);
            score = 0; lives = INITIAL_BUCKET_COUNT; frame = 0; speedMultiplier = 1; level = 1;
            levelCatches = 0; totalCatchesNeeded = 15; bombsDroppedInAttempt = 0; isTransitioningLevel = false;
            madBomberX = 0; madBomberSpeed = settings.initialBomberSpeed;
            bombs.forEach(b => b.element.remove()); bombs = [];
            document.getElementById('overlay').classList.add('hidden');
            document.getElementById('mad-bomber-img').style.display = 'block';
            document.getElementById('game-area').classList.add('hide-pointer');
            initGameElements();
            updateScoreDisplay();
            gameLoop();
        }

        function startNextLevel() {
            level++;
            isTransitioningLevel = false;
            levelCatches = 0; bombsDroppedInAttempt = 0;
            totalCatchesNeeded = 15 + (level * 5); 
            speedMultiplier += 0.15;
            showTemporaryMessage(`LEVEL ${level}`, "text-yellow-400");
            updateScoreDisplay();
            isGamePaused = false;
            gameLoop();
            triggerHaptic([100, 50, 100]);
        }

        function initGameElements() {
            const theme = THEMES[currentThemeId];
            const stack = document.getElementById('buckets-stack');
            const bomberEl = document.getElementById('mad-bomber-img');
            document.getElementById('game-area').style.backgroundImage = `url('${theme.graphics.BACKGROUND}')`;
            stack.innerHTML = ''; bucketElements = [];
            stack.style.width = `${theme.bucketDim.w}px`;
            if (theme.isStacked) {
                for (let i = 0; i < INITIAL_BUCKET_COUNT; i++) {
                    const b = document.createElement('img');
                    b.src = theme.graphics.BUCKET;
                    b.className = 'bucket-img pixel-art';
                    b.style.width = `${theme.bucketDim.w}px`;
                    b.style.height = `${theme.bucketDim.h}px`;
                    stack.appendChild(b);
                    bucketElements.push(b);
                }
            } else {
                const b = document.createElement('img');
                b.id = 'single-catcher-img';
                b.className = 'bucket-img pixel-art';
                b.style.width = `${theme.bucketDim.w}px`;
                b.style.height = `${theme.bucketDim.h}px`;
                stack.appendChild(b);
                bucketElements.push(b);
            }
            bomberEl.src = theme.graphics.BOMBER;
            bomberEl.className = 'mad-bomber-img pixel-art';
            bomberEl.style.width = `${theme.bomberDim.w}px`;
            bomberEl.style.height = `${theme.bomberDim.h}px`;
        }

        function gameLoop() {
            if (isGameOver || isGamePaused) return;
            frame++;
            updateBomber();
            updateBombs();
            document.getElementById('score-display').textContent = score;
            animationFrameHandle = requestAnimationFrame(gameLoop);
        }

        function updateBomber() {
            const theme = THEMES[currentThemeId];
            madBomberX += madBomberDirection * (madBomberSpeed * speedMultiplier);
            if (madBomberX > (GAME_AREA_WIDTH - theme.bomberDim.w)) { madBomberDirection = -1; madBomberX = GAME_AREA_WIDTH - theme.bomberDim.w; }
            else if (madBomberX < 0) { madBomberDirection = 1; madBomberX = 0; }
            document.getElementById('mad-bomber-img').style.left = `${madBomberX}px`;
            const settings = theme.settings[currentDifficulty];
            madBomberSpeed = Math.min(settings.initialBomberSpeed + (Math.floor(score / 30) * 0.1), 8);
            if (bombsDroppedInAttempt < totalCatchesNeeded) {
                const dropInt = Math.max(8, settings.initialDropInterval - (level * 5) - Math.floor(score / 15));
                if (frame % Math.floor(dropInt) === 0) {
                    const x = madBomberX + (theme.bomberDim.w / 2) - (theme.bombDim.w / 2);
                    createBomb(x, theme.bomberDim.h);
                    bombsDroppedInAttempt++;
                }
            }
        }

        function createBomb(x, y) {
            const theme = THEMES[currentThemeId];
            const el = document.createElement('img');
            el.src = theme.graphics.BOMB;
            el.className = 'bomb-img pixel-art';
            el.style.width = `${theme.bombDim.w}px`;
            el.style.height = `${theme.bombDim.h}px`;
            el.style.left = `${x}px`; el.style.top = `${y}px`;
            document.getElementById('game-area').appendChild(el);
            bombs.push({ x, y, el, speed: (theme.settings[currentDifficulty].baseBombSpeed + (level * 0.1)) * speedMultiplier });
        }

        function updateBombs() {
            const theme = THEMES[currentThemeId];
            const hitbox = getCurrentHitbox();
            let catchTopY = theme.isStacked ? GAME_AREA_HEIGHT - (lives * (theme.bucketDim.h + theme.bucketDim.gap)) : GAME_AREA_HEIGHT - theme.bucketDim.h + hitbox.yOffset;
            for (let i = bombs.length - 1; i >= 0; i--) {
                const b = bombs[i];
                b.y += b.speed;
                b.el.style.top = `${b.y}px`;
                if (b.y + theme.bombDim.h > GAME_AREA_HEIGHT) { handleMiss(i, b); } 
                else if (lives > 0) {
                    const cXStart = bucketX + hitbox.xOffset, cXEnd = cXStart + hitbox.catchW, midX = b.x + (theme.bombDim.w / 2);
                    if (b.y + theme.bombDim.h > catchTopY && b.y < catchTopY + hitbox.catchH && midX > cXStart && midX < cXEnd) { handleCatch(i, b, catchTopY); }
                }
            }
            if (!isGameOver && levelCatches >= totalCatchesNeeded && bombs.length === 0 && !isTransitioningLevel) {
                isTransitioningLevel = true; isGamePaused = true;
                showTemporaryMessage("LEVEL COMPLETE!", "text-green-400");
                setTimeout(startNextLevel, 2000);
            }
        }

        function showBigCountdown(num) {
            const container = document.getElementById('game-area');
            const el = document.createElement('div');
            el.className = 'countdown-number';
            el.textContent = num;
            container.appendChild(el);
            setTimeout(() => el.remove(), 400);
        }

        function handleCatch(idx, b, topY) {
            score++;
            levelCatches++;
            const left = totalCatchesNeeded - levelCatches;
            if (left <= 5 && left > 0) showBigCountdown(left);
            updateScoreDisplay();
            triggerHaptic(20);
            const theme = THEMES[currentThemeId];
            const centerX = b.x + (theme.bombDim.w / 2);
            createSplash(centerX, topY);
            b.el.remove(); bombs.splice(idx, 1);
            if (score > 0 && score % 1000 === 0 && lives < INITIAL_BUCKET_COUNT) {
                lives++; showTemporaryMessage("Extra Layer!", "text-green-400"); updateScoreDisplay();
            }
        }

        function handleMiss(idx, b) {
            lives--; isGamePaused = true;
            levelCatches = 0; bombsDroppedInAttempt = 0;
            triggerHaptic([100, 50, 150]);
            const theme = THEMES[currentThemeId];
            if (lives > 0) speedMultiplier = Math.max(1.0, speedMultiplier - 0.15);
            const centerX = b.x + (theme.bombDim.w / 2), centerY = b.y + (theme.bombDim.h / 2);
            createExplosion(centerX, centerY);
            b.el.remove(); bombs.splice(idx, 1);
            updateScoreDisplay();
            showTemporaryMessage("OOPS!", "text-red-500");
            setTimeout(() => { detonateRemaining(lives <= 0); }, theme.missDuration);
        }

        function detonateRemaining(isLast) {
            const toEx = [...bombs]; bombs = [];
            const theme = THEMES[currentThemeId];
            if (toEx.length === 0) { setTimeout(() => { if (isLast) endGame(); else resume(); }, 500); return; }
            toEx.sort((a, b) => b.y - a.y);
            toEx.forEach((b, i) => {
                setTimeout(() => {
                    const centerX = b.x + (theme.bombDim.w / 2), centerY = b.y + (theme.bombDim.h / 2);
                    createExplosion(centerX, centerY);
                    b.el.remove();
                    triggerHaptic(50);
                }, (i * EXPLOSION_CHAIN_DELAY));
            });
            setTimeout(() => { if (isLast) endGame(); else resume(); }, (toEx.length * EXPLOSION_CHAIN_DELAY) + 500);
        }

        function resume() { if (isTransitioningLevel) return; showTemporaryMessage("", ""); isGamePaused = false; gameLoop(); }

        function endGame() {
            isGameOver = true; isGamePaused = true;
            triggerHaptic([200, 100, 200]);
            if (animationFrameHandle) cancelAnimationFrame(animationFrameHandle);
            if (score > highscore && highscoreRef) setDoc(highscoreRef, { score, timestamp: new Date() }, { merge: true });
            document.getElementById('game-area').classList.remove('hide-pointer');
            showThemeSelection(true);
        }

        function createExplosion(centerX, centerY) {
            const theme = THEMES[currentThemeId];
            const el = document.createElement('img');
            el.src = theme.graphics.EXPLOSION + "?t=" + Date.now();
            el.className = 'explosion-img pixel-art';
            el.style.width = `${theme.explosionDim.w}px`; el.style.height = `${theme.explosionDim.h}px`;
            el.style.left = `${centerX - theme.explosionDim.w / 2}px`; el.style.top = `${centerY - theme.explosionDim.h / 2}px`;
            document.getElementById('game-area').appendChild(el);
            setTimeout(() => el.remove(), theme.missDuration);
        }

        function createSplash(centerX, hitboxTopY) {
            const theme = THEMES[currentThemeId];
            const el = document.createElement('img');
            el.src = theme.graphics.SPLASH + "?t=" + Date.now();
            el.className = 'splash-img pixel-art';
            el.style.width = `${theme.splashDim.w}px`; el.style.height = `${theme.splashDim.h}px`;
            el.style.left = `${centerX - theme.splashDim.w / 2}px`; el.style.top = `${hitboxTopY - theme.splashDim.h}px`;
            document.getElementById('game-area').appendChild(el);
            setTimeout(() => el.remove(), theme.catchDuration);
        }

        function updateScoreDisplay() {
            document.getElementById('score-display').textContent = score.toString().padStart(6, '0');
            document.getElementById('highscore-display').textContent = highscore;
            document.getElementById('level-display').textContent = level;
            document.getElementById('left-display').textContent = Math.max(0, totalCatchesNeeded - levelCatches);
            const theme = THEMES[currentThemeId];
            const stack = document.getElementById('buckets-stack');
            if (theme.isStacked) {
                const h = lives * (theme.bucketDim.h + theme.bucketDim.gap);
                stack.style.height = `${h}px`; stack.style.top = `${GAME_AREA_HEIGHT - h}px`;
                bucketElements.forEach((el, idx) => el.style.display = idx < lives ? 'block' : 'none');
            } else {
                stack.style.height = `${theme.bucketDim.h}px`; stack.style.top = `${GAME_AREA_HEIGHT - theme.bucketDim.h}px`;
                const img = document.getElementById('single-catcher-img');
                if (img) img.src = theme.graphics.BUCKET_LAYERS[lives];
            }
        }

        function showThemeSelection(isOver = false) {
            const overlay = document.getElementById('overlay');
            const msg = document.getElementById('status-message');
            const btns = document.getElementById('difficulty-buttons');
            overlay.classList.remove('hidden'); overlay.style.opacity = 1;
            btns.innerHTML = '';
            if (isOver) msg.innerHTML = `<p class="text-4xl font-extrabold text-red-500 mb-4 uppercase italic">GAME OVER</p><p class="text-xl mb-2 text-gray-300">Score: ${score}</p><p class="text-lg mb-8 text-gray-400 font-mono">Level ${level}</p>`;
            else msg.innerHTML = `<p class="text-5xl font-extrabold text-yellow-400 mb-4 uppercase tracking-tighter italic">KABOOM!</p><p class="text-xl mb-8 text-gray-300">Select Version</p>`;
            Object.keys(THEMES).forEach(id => {
                const b = document.createElement('button');
                b.textContent = THEMES[id].title;
                b.className = 'bg-indigo-600 text-white font-extrabold py-4 px-8 rounded-lg m-2 uppercase hover:scale-105 transition w-64 shadow-lg active:bg-indigo-800';
                b.onclick = () => { triggerHaptic(10); showDifficultySelection(id); };
                btns.appendChild(b);
            });
        }

        function showDifficultySelection(themeId) {
            const btns = document.getElementById('difficulty-buttons');
            const theme = THEMES[themeId];
            document.getElementById('status-message').innerHTML = `<p class="text-3xl font-bold text-yellow-400 mb-2 uppercase italic">${theme.title}</p><p class="text-gray-400 mb-8 max-w-xs mx-auto text-sm">${theme.description}</p>`;
            btns.innerHTML = '';
            ['EASY', 'MEDIUM', 'HARD'].forEach(l => {
                const b = document.createElement('button');
                b.textContent = l;
                const colors = { EASY: 'bg-green-600 active:bg-green-800', MEDIUM: 'bg-yellow-600 active:bg-yellow-800', HARD: 'bg-red-600 active:bg-red-800' };
                b.className = `${colors[l]} text-white font-extrabold py-3 px-8 rounded-full m-2 uppercase hover:scale-105 transition shadow-md w-32`;
                b.onclick = () => { triggerHaptic(20); startGame(themeId, l); };
                btns.appendChild(b);
            });
            const back = document.createElement('button');
            back.textContent = 'Back'; back.className = 'bg-gray-700 text-white font-bold py-2 px-4 rounded-full mt-8 block mx-auto text-xs opacity-50 hover:opacity-100 transition';
            back.onclick = () => { triggerHaptic(5); showThemeSelection(); };
            btns.appendChild(back);
        }

        function handleInteraction(e) {
            if (isGameOver) return;
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const rect = document.getElementById('game-area').getBoundingClientRect();
            const hitbox = getCurrentHitbox();
            const minX = 0 - hitbox.xOffset, maxX = GAME_AREA_WIDTH - (hitbox.xOffset + hitbox.catchW);
            const imageLeft = (clientX - rect.left) - (hitbox.xOffset + hitbox.catchW / 2);
            bucketX = Math.max(minX, Math.min(imageLeft, maxX));
            document.getElementById('buckets-stack').style.left = `${bucketX}px`;

            if (e.type === 'touchstart' || e.type === 'mousedown') {
                const now = Date.now();
                if (isGamePaused) {
                    if (!isTransitioningLevel && document.getElementById('temp-message').textContent !== "OOPS!") togglePauseGesture();
                } else {
                    if (now - lastTapTime < 300) togglePauseGesture();
                }
                lastTapTime = now;
            }
        }

        function togglePauseGesture() {
            isGamePaused = !isGamePaused;
            triggerHaptic(15);
            if (isGamePaused) showTemporaryMessage("PAUSED", "text-blue-400");
            else { showTemporaryMessage("GO!", "text-green-400"); gameLoop(); }
        }

        function showTemporaryMessage(text, color) {
            const el = document.getElementById('temp-message');
            el.textContent = text;
            if (text === "") { el.style.opacity = 0; return; }
            el.className = `absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-4xl font-black p-3 rounded-lg z-20 transition-opacity duration-300 ${color} shadow-2xl text-center uppercase italic`;
            el.style.opacity = 1;
            if (text === "OOPS!" || text === "GO!" || text === "LEVEL COMPLETE!" || text.startsWith("LEVEL ")) setTimeout(() => el.style.opacity = 0, 1500);
        }

        window.onload = () => {
            initFirebase();
            showThemeSelection();
            const area = document.getElementById('game-area');
            area.addEventListener('mousemove', handleInteraction);
            area.addEventListener('mousedown', handleInteraction);
            area.addEventListener('touchstart', handleInteraction, { passive: false });
            area.addEventListener('touchmove', handleInteraction, { passive: false });
        };
    </script>
</head>
<body class="flex flex-col items-center justify-start min-h-screen p-2 pt-4">
    <div id="preload-cache"></div>

    <div id="game-container" class="w-full flex flex-col items-center">
        <!-- CONDENSED SINGLE-ROW SCOREBOARD -->
        <div class="w-full max-w-[400px] bg-gray-900 px-4 py-2 rounded-t-lg shadow-2xl flex justify-between items-center border-t-2 border-x-2 border-yellow-500 font-mono">
            <div class="flex items-baseline gap-2">
                <span class="text-[10px] text-gray-500 font-bold uppercase tracking-tighter">HI</span>
                <span id="highscore-display" class="text-yellow-400 font-bold text-sm">0</span>
            </div>
            
            <div class="flex items-center gap-3">
                <div class="flex items-baseline gap-1">
                    <span class="text-[10px] text-gray-500 font-bold uppercase tracking-tighter">LVL</span>
                    <span id="level-display" class="text-white font-bold text-sm">1</span>
                </div>
                <div class="bg-gray-800 px-2 py-0.5 rounded text-[10px] font-bold text-yellow-400">
                    <span id="left-display">15</span> LEFT
                </div>
            </div>

            <div id="score-display" class="text-green-400 font-black text-lg tracking-wider">000000</div>
        </div>

        <!-- PLAY AREA -->
        <div id="game-area" class="w-full h-[600px] max-w-[400px] rounded-b-lg relative shadow-2xl overflow-hidden border-b-2 border-x-2 border-gray-800">
            <img id="mad-bomber-img" class="mad-bomber-img" style="display: none;" alt="Bomber">
            <div id="buckets-stack" class="bucket-stack"></div>
            <div id="temp-message" class="transition-opacity duration-300 opacity-0 pointer-events-none text-center"></div>
            <div id="overlay" class="game-status-overlay hidden">
                <div class="text-center p-6"><div id="status-message" class="mb-8"></div><div id="difficulty-buttons" class="flex flex-wrap justify-center items-center"></div></div>
            </div>
        </div>
    </div>
    
    <div class="mt-4 text-[9px] text-gray-700 font-mono flex flex-col gap-1 items-center uppercase tracking-widest text-center">
        <p>Double-Tap to Pause â€¢ Single Tap to Resume</p>
        <span>Player ID: <span id="user-id-display">Connecting...</span></span>
    </div>
</body>
</html>


