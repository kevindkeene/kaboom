<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kaboom! - Global Arcade</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;800;900&display=swap');
        
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #f9fafb; margin: 0; overflow: hidden; }
        
        #game-area {
            position: relative;
            width: 100%;
            max-width: 400px;
            height: 600px;
            background-size: cover;
            background-repeat: no-repeat;
            border: none; 
            overflow: hidden;
            margin: auto;
            touch-action: none; 
            cursor: crosshair;
        }

        #game-area.hide-pointer { cursor: none !important; }

        .pixel-art {
            image-rendering: pixelated;
            image-rendering: crisp-edges;
        }

        .mad-bomber-img {
            position: absolute;
            top: 0;
            left: 0;
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .bucket-stack {
            position: absolute;
            display: flex;
            flex-direction: column-reverse; 
            align-items: center;
            justify-content: flex-start;
            z-index: 90;
            transition: top 0.2s ease-out;
        }

        .bucket-img { object-fit: contain; width: 100%; height: 100%; }

        .bomb-img { position: absolute; z-index: 50; transition: opacity 0.1s; }
        .splash-img { position: absolute; z-index: 250; pointer-events: none; }
        .explosion-img { position: absolute; z-index: 200; pointer-events: none; }

        .game-status-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(8px);
            z-index: 300;
            transition: opacity 0.3s;
        }

        @keyframes recordPulse {
            0% { transform: scale(1); text-shadow: 0 0 0px gold; }
            30% { transform: scale(1.1); text-shadow: 0 0 15px gold, 0 0 5px gold; }
            100% { transform: scale(1); text-shadow: 0 0 0px gold; }
        }

        .pulse-active { animation: recordPulse 0.3s ease-out; }

        .countdown-number {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 12rem;
            font-weight: 900;
            color: rgba(255, 255, 255, 0.7);
            pointer-events: none;
            z-index: 150;
            line-height: 1;
            animation: countdownScaleFade 0.4s ease-out forwards;
        }

        @keyframes countdownScaleFade {
            0% { transform: translate(-50%, -50%) scale(3); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(0.8); opacity: 0; }
        }

        .ticker-container {
            height: 40px;
            overflow: hidden;
            position: relative;
        }
        
        .ticker-item {
            height: 40px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .initials-input {
            background: #000;
            border: 4px solid #ef4444;
            color: #ef4444;
            font-family: monospace;
            font-size: 3rem;
            font-weight: 900;
            text-align: center;
            width: 220px;
            padding: 10px;
            text-transform: uppercase;
            letter-spacing: 10px;
            outline: none;
            margin-bottom: 20px;
        }

        #preload-cache {
            position: absolute;
            width: 0; height: 0;
            overflow: hidden;
            opacity: 0;
            pointer-events: none;
        }
    </style>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        const GAME_AREA_WIDTH = 400;
        const GAME_AREA_HEIGHT = 600;
        const INITIAL_BUCKET_COUNT = 3;
        const EXPLOSION_CHAIN_DELAY = 750; 
        
        const THEMES = {
            'classic': {
                title: 'Classic', id: 'classic', isStacked: true,
                bomberDim: { w: 21, h: 50 }, bombDim: { w: 15, h: 28 },
                bucketDim: { w: 50, h: 20, gap: 2 }, splashDim: { w: 33, h: 46 },
                explosionDim: { w: 80, h: 64 }, catchDuration: 780, missDuration: 1240,
                hitbox: { xOffset: 0, catchW: 50, yOffset: 0, catchH: 20 }, 
                emoji: { bomber: 'ðŸ’£', bomb: 'ðŸ§¨', bucket: 'ðŸ—‘ï¸' },
                graphics: {
                    BOMBER: 'https://kevindkeene.github.io/kaboom/assets/bomber336x800.gif',
                    BOMB: 'https://kevindkeene.github.io/kaboom/assets/bomb240x448.gif',
                    BUCKET: 'https://kevindkeene.github.io/kaboom/assets/bucket.gif', 
                    EXPLOSION: 'https://kevindkeene.github.io/kaboom/assets/explosion320x256.gif',
                    SPLASH: 'https://kevindkeene.github.io/kaboom/assets/splash264x368.gif',
                    BACKGROUND: 'https://kevindkeene.github.io/kaboom/assets/kaboom-background.gif'
                },
                settings: {
                    EASY: { baseBombSpeed: 2.0, initialDropInterval: 120, initialBomberSpeed: 1.2, twitchChance: 0.005 },
                    MEDIUM: { baseBombSpeed: 2.5, initialDropInterval: 100, initialBomberSpeed: 1.8, twitchChance: 0.015 },
                    HARD: { baseBombSpeed: 3.2, initialDropInterval: 70, initialBomberSpeed: 2.5, twitchChance: 0.03 }
                }
            },
            'alien-drop': {
                title: 'Alien Drop', id: 'alien-drop', isStacked: false,
                bomberDim: { w: 50, h: 50 }, bombDim: { w: 32, h: 26 }, 
                bucketDim: { w: 220, h: 80, gap: 0 }, splashDim: { w: 80, h: 80 },
                explosionDim: { w: 80, h: 80 }, catchDuration: 900, missDuration: 1240,
                hitboxByLife: [
                    { xOffset: 115, catchW: 100, yOffset: 38, catchH: 18 }, 
                    { xOffset: 115, catchW: 100, yOffset: 19, catchH: 37 }, 
                    { xOffset: 115, catchW: 100, yOffset: 0,  catchH: 56 }  
                ],
                emoji: { bomber: 'ðŸ›¸', bomb: 'ðŸ„', bucket: 'ðŸšœ' },
                graphics: {
                    BOMBER: 'https://kevindkeene.github.io/kaboom/assets/ufo2-400x400.gif', 
                    BOMB: 'https://kevindkeene.github.io/kaboom/assets/cow3.gif', 
                    BUCKET_LAYERS: [
                        'https://kevindkeene.github.io/kaboom/assets/tractor-0hay.gif',
                        'https://kevindkeene.github.io/kaboom/assets/tractor-1hay.gif',
                        'https://kevindkeene.github.io/kaboom/assets/tractor-2hay.gif',
                        'https://kevindkeene.github.io/kaboom/assets/tractor-3hay.gif'
                    ],
                    EXPLOSION: 'https://kevindkeene.github.io/kaboom/assets/cow3-explode.gif', 
                    SPLASH: 'https://kevindkeene.github.io/kaboom/assets/burst.gif',
                    BACKGROUND: 'https://kevindkeene.github.io/kaboom/assets/alien_background2.gif'
                },
                settings: {
                    EASY: { baseBombSpeed: 2.5, initialDropInterval: 100, initialBomberSpeed: 1.8, twitchChance: 0.01 },
                    MEDIUM: { baseBombSpeed: 3.0, initialDropInterval: 80, initialBomberSpeed: 2.3, twitchChance: 0.02 },
                    HARD: { baseBombSpeed: 3.8, initialDropInterval: 60, initialBomberSpeed: 3.0, twitchChance: 0.04 }
                }
            }
        };

        let score = 0, lives = INITIAL_BUCKET_COUNT, globalHighscore = 0, level = 1;
        let isGameOver = true, isGamePaused = true, frame = 0;
        let bombs = [], bucketElements = [];
        let currentThemeId = 'classic', currentDifficulty = 'MEDIUM';
        let bucketX = 0, madBomberX = 0, madBomberDirection = 1;
        let speedMultiplier = 1, madBomberSpeed = 1.5;
        let levelCatches = 0, totalCatchesNeeded = 15, bombsDroppedInAttempt = 0;
        let isTransitioningLevel = false;
        let lastTapTime = 0, madBomberTargetX = null;
        let worldRecords = { 'classic': 0, 'alien-drop': 0 };
        let worldInitials = { 'classic': '---', 'alien-drop': '---' };
        let worldLevels = { 'classic': 1, 'alien-drop': 1 }; 
        let tickerIndex = 0, tickerInterval;
        let db, auth, userId, globalScoresRef, animationFrameHandle;

        function triggerHaptic(pattern) { if ("vibrate" in navigator) { navigator.vibrate(pattern); } }

        function getCurrentHitbox() {
            const theme = THEMES[currentThemeId];
            if (theme.isStacked) return theme.hitbox;
            return theme.hitboxByLife[Math.max(0, lives - 1)];
        }

        async function initFirebase() {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'kaboom-arcade';
            const firebaseConfigString = typeof __firebase_config !== 'undefined' ? __firebase_config : null;
            if (!firebaseConfigString) return;
            const app = initializeApp(JSON.parse(firebaseConfigString));
            db = getFirestore(app); auth = getAuth(app);
            const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
            try { if (token) await signInWithCustomToken(auth, token); else await signInAnonymously(auth); } catch (e) {}
            onAuthStateChanged(auth, (u) => {
                if (u) {
                    userId = u.uid; document.getElementById('user-id-display').textContent = userId;
                    globalScoresRef = doc(db, 'artifacts', appId, 'public', 'data', 'globalScores', 'hallOfFame');
                    onSnapshot(globalScoresRef, (snap) => {
                        if (snap.exists()) {
                            const data = snap.data();
                            Object.keys(THEMES).forEach(id => {
                                worldRecords[id] = data[id] || 0;
                                worldInitials[id] = data[id + '_initials'] || '---';
                                worldLevels[id] = data[id + '_level'] || 1;
                            });
                            const numericScores = Object.values(worldRecords).filter(val => typeof val === 'number');
                            globalHighscore = numericScores.length > 0 ? Math.max(...numericScores) : 0;
                            updateScoreDisplay();
                        }
                    });
                }
            });
        }

        async function saveWorldRecord(themeId, currentScore, currentLevel, initials) {
            if (!userId || !globalScoresRef) return;
            const update = {}; update[themeId] = currentScore;
            update[themeId + '_initials'] = initials; update[themeId + '_level'] = currentLevel;
            update[themeId + '_holder'] = userId;
            try { await setDoc(globalScoresRef, update, { merge: true }); triggerHaptic([50, 50, 50, 50, 100]); } 
            catch (e) {}
        }

        function startHighscoreTicker() {
            if (tickerInterval) clearInterval(tickerInterval);
            tickerInterval = setInterval(() => {
                const ids = Object.keys(THEMES);
                tickerIndex = (tickerIndex + 1) % ids.length;
                const id = ids[tickerIndex];
                const tickerInner = document.getElementById('ticker-inner');
                if (tickerInner) {
                    tickerInner.style.transform = 'translateY(100%)';
                    setTimeout(() => {
                        document.getElementById('ticker-theme-name').textContent = THEMES[id].title + " WORLD BEST";
                        document.getElementById('ticker-theme-score').textContent = `${worldInitials[id]} - ${(worldRecords[id]||0).toString().padStart(6,'0')} L${worldLevels[id]||1}`;
                        tickerInner.style.transition = 'none'; tickerInner.style.transform = 'translateY(-100%)';
                        tickerInner.offsetHeight; tickerInner.style.transition = 'transform 0.5s cubic-bezier(0.4, 0, 0.2, 1)';
                        tickerInner.style.transform = 'translateY(0)';
                    }, 500);
                }
            }, 3000);
        }

        function startGame(themeId, diff) {
            isGameOver = false; currentThemeId = themeId; currentDifficulty = diff;
            const theme = THEMES[themeId];
            if (tickerInterval) clearInterval(tickerInterval);
            if (animationFrameHandle) cancelAnimationFrame(animationFrameHandle);
            
            score = 0; lives = INITIAL_BUCKET_COUNT; frame = 0; speedMultiplier = 1; level = 1;
            levelCatches = 0; totalCatchesNeeded = 15; bombsDroppedInAttempt = 0; isTransitioningLevel = false;
            madBomberX = GAME_AREA_WIDTH / 2; madBomberSpeed = theme.settings[diff].initialBomberSpeed;
            madBomberTargetX = null;
            bombs.forEach(b => { if(b.el) b.el.remove(); }); bombs = [];
            
            initGameElements();
            updateScoreDisplay();
            
            document.getElementById('overlay').classList.add('hidden');
            document.getElementById('mad-bomber-img').style.display = 'flex';
            document.getElementById('game-area').classList.add('hide-pointer');
            document.getElementById('header-stats-play').classList.remove('hidden');
            document.getElementById('header-stats-menu').classList.add('hidden');
            
            isGamePaused = false;
            gameLoop();
        }

        function startNextLevel() {
            level++; isTransitioningLevel = false; levelCatches = 0; bombsDroppedInAttempt = 0;
            totalCatchesNeeded = 15 + (level * 5); speedMultiplier += 0.15;
            showTemporaryMessage(`LEVEL ${level}`, "text-yellow-400");
            updateScoreDisplay(); isGamePaused = false; gameLoop(); triggerHaptic([100, 50, 100]);
        }

        function initGameElements() {
            const theme = THEMES[currentThemeId];
            const stack = document.getElementById('buckets-stack');
            const bomberEl = document.getElementById('mad-bomber-img');
            document.getElementById('game-area').style.backgroundImage = `url('${theme.graphics.BACKGROUND}')`;
            stack.innerHTML = ''; bucketElements = [];
            stack.style.width = `${theme.bucketDim.w}px`;
            
            if (theme.isStacked) {
                for (let i = 0; i < lives; i++) {
                    const b = document.createElement('img');
                    b.src = theme.graphics.BUCKET; b.className = 'bucket-img pixel-art';
                    b.onerror = () => { b.style.display='none'; stack.innerHTML += `<div class="text-2xl">${theme.emoji.bucket}</div>`; };
                    stack.appendChild(b); bucketElements.push(b);
                }
            } else {
                const b = document.createElement('img');
                b.id = 'single-catcher-img'; b.className = 'bucket-img pixel-art';
                b.src = theme.graphics.BUCKET_LAYERS[lives];
                b.onerror = () => { b.style.display='none'; stack.innerHTML = `<div class="text-5xl">${theme.emoji.bucket}</div>`; };
                stack.appendChild(b); bucketElements.push(b);
            }
            const h = theme.isStacked ? lives * (theme.bucketDim.h + theme.bucketDim.gap) : theme.bucketDim.h;
            stack.style.height = `${h}px`; stack.style.top = `${GAME_AREA_HEIGHT - h}px`;

            // Reset Bomber Image
            bomberEl.innerHTML = '';
            const bImg = document.createElement('img');
            bImg.src = theme.graphics.BOMBER; bImg.className = 'pixel-art w-full h-full';
            bImg.onerror = () => { bImg.style.display='none'; bomberEl.innerHTML = `<span class="text-4xl">${theme.emoji.bomber}</span>`; };
            bomberEl.appendChild(bImg);
            bomberEl.style.width = `${theme.bomberDim.w}px`; bomberEl.style.height = `${theme.bomberDim.h}px`;
            bomberEl.style.left = `${madBomberX}px`;
            
            document.getElementById('life-icon').src = theme.isStacked ? theme.graphics.BUCKET : theme.graphics.BUCKET_LAYERS[1];
        }

        function gameLoop() {
            if (isGameOver || isGamePaused) return;
            frame++; updateBomber(); updateBombs();
            animationFrameHandle = requestAnimationFrame(gameLoop);
        }

        function updateBomber() {
            const theme = THEMES[currentThemeId];
            const settings = theme.settings[currentDifficulty];
            const baseSpeed = madBomberSpeed * speedMultiplier;
            if (madBomberTargetX !== null) {
                const zipSpeed = baseSpeed * 4;
                const dist = madBomberTargetX - madBomberX;
                if (Math.abs(dist) < zipSpeed) { madBomberX = madBomberTargetX; madBomberTargetX = null; } 
                else { madBomberX += Math.sign(dist) * zipSpeed; }
            } else {
                if (Math.random() < (settings.twitchChance + (level * 0.005))) madBomberDirection *= -1;
                madBomberX += madBomberDirection * baseSpeed;
                if (madBomberX > (GAME_AREA_WIDTH - theme.bomberDim.w)) { madBomberDirection = -1; madBomberX = GAME_AREA_WIDTH - theme.bomberDim.w; } 
                else if (madBomberX < 0) { madBomberDirection = 1; madBomberX = 0; }
            }
            document.getElementById('mad-bomber-img').style.left = `${madBomberX}px`;
            madBomberSpeed = Math.min(settings.initialBomberSpeed + (Math.floor(score / 30) * 0.1), 8);
            if (bombsDroppedInAttempt < totalCatchesNeeded) {
                const dropInt = Math.max(8, settings.initialDropInterval - (level * 5) - Math.floor(score / 15));
                if (frame % Math.floor(dropInt) === 0) {
                    createBomb(madBomberX + (theme.bomberDim.w/2) - (theme.bombDim.w/2), theme.bomberDim.h);
                    bombsDroppedInAttempt++;
                    const minJump = GAME_AREA_WIDTH * 0.4;
                    let newX = Math.random() * (GAME_AREA_WIDTH - theme.bomberDim.w);
                    let att = 0; while (Math.abs(newX - madBomberX) < minJump && att < 10) { newX = Math.random() * (GAME_AREA_WIDTH - theme.bomberDim.w); att++; }
                    madBomberTargetX = newX;
                }
            }
        }

        function createBomb(x, y) {
            const theme = THEMES[currentThemeId];
            const el = document.createElement('div');
            el.className = 'bomb-img pixel-art absolute flex items-center justify-center';
            el.style.width = `${theme.bombDim.w}px`; el.style.height = `${theme.bombDim.h}px`;
            el.style.left = `${x}px`; el.style.top = `${y}px`;
            const bImg = document.createElement('img');
            bImg.src = theme.graphics.BOMB; bImg.className = 'w-full h-full';
            bImg.onerror = () => { bImg.style.display='none'; el.innerHTML = `<span style="font-size: ${theme.bombDim.h}px">${theme.emoji.bomb}</span>`; };
            el.appendChild(bImg);
            document.getElementById('game-area').appendChild(el);
            bombs.push({ x, y, el, speed: (theme.settings[currentDifficulty].baseBombSpeed + (level * 0.1)) * speedMultiplier });
        }

        function updateBombs() {
            const hitbox = getCurrentHitbox();
            const theme = THEMES[currentThemeId];
            let catchTopY = theme.isStacked ? GAME_AREA_HEIGHT - (lives * (theme.bucketDim.h + theme.bucketDim.gap)) : GAME_AREA_HEIGHT - theme.bucketDim.h + hitbox.yOffset;
            for (let i = bombs.length - 1; i >= 0; i--) {
                if (isGamePaused) break;
                const b = bombs[i]; b.y += b.speed; b.el.style.top = `${b.y}px`;
                if (b.y + theme.bombDim.h > GAME_AREA_HEIGHT) { handleMiss(i, b); } 
                else if (lives > 0) {
                    const midX = b.x + (theme.bombDim.w / 2);
                    if (b.y + theme.bombDim.h > catchTopY && b.y < catchTopY + hitbox.catchH && midX > bucketX + hitbox.xOffset && midX < bucketX + hitbox.xOffset + hitbox.catchW) { handleCatch(i, b, catchTopY); }
                }
            }
            if (!isGameOver && levelCatches >= totalCatchesNeeded && bombs.length === 0 && !isTransitioningLevel && !isGamePaused) {
                isTransitioningLevel = true; isGamePaused = true;
                showTemporaryMessage("LEVEL COMPLETE!", "text-green-400"); setTimeout(startNextLevel, 2000);
            }
        }

        function handleCatch(idx, b, topY) {
            const record = worldRecords[currentThemeId] || 0;
            score++; levelCatches++;
            if (totalCatchesNeeded - levelCatches <= 5 && totalCatchesNeeded - levelCatches > 0) {
                const el = document.createElement('div'); el.className = 'countdown-number font-mono';
                el.textContent = totalCatchesNeeded - levelCatches; document.getElementById('game-area').appendChild(el);
                setTimeout(() => el.remove(), 400);
            }
            if (score > record) {
                const hi = document.getElementById('hi-score-container');
                hi.classList.remove('pulse-active'); void hi.offsetWidth; hi.classList.add('pulse-active');
                triggerHaptic(30); 
            }
            updateScoreDisplay(); triggerHaptic(20);
            createSplash(b.x + (THEMES[currentThemeId].bombDim.w / 2), topY);
            if (b.el) b.el.remove(); bombs.splice(idx, 1);
            if (score > 0 && score % 1000 === 0 && lives < INITIAL_BUCKET_COUNT) {
                lives++; showTemporaryMessage("Extra Layer!", "text-green-400"); updateScoreDisplay();
            }
        }

        function handleMiss(idx, b) {
            if (isGamePaused && !isGameOver && lives > 0) return;
            isGamePaused = true; lives--; levelCatches = 0; bombsDroppedInAttempt = 0;
            triggerHaptic([100, 50, 150]);
            if (lives > 0) speedMultiplier = Math.max(1.0, speedMultiplier - 0.15);
            createExplosion(b.x + (THEMES[currentThemeId].bombDim.w / 2), b.y + (THEMES[currentThemeId].bombDim.h / 2));
            if (b.el) b.el.remove(); bombs.splice(idx, 1);
            updateScoreDisplay(); showTemporaryMessage("OOPS!", "text-red-500");
            setTimeout(() => { detonateRemaining(lives <= 0); }, THEMES[currentThemeId].missDuration);
        }

        function detonateRemaining(isLast) {
            const toEx = [...bombs]; bombs = [];
            if (toEx.length === 0) { setTimeout(() => { if (isLast) endGame(); else resume(); }, 500); return; }
            toEx.sort((a, b) => b.y - a.y);
            toEx.forEach((b, i) => {
                setTimeout(() => {
                    createExplosion(b.x + (THEMES[currentThemeId].bombDim.w / 2), b.y + (THEMES[currentThemeId].bombDim.h / 2));
                    if (b.el) b.el.remove(); triggerHaptic(50);
                }, (i * EXPLOSION_CHAIN_DELAY));
            });
            setTimeout(() => { if (isLast) endGame(); else resume(); }, (toEx.length * EXPLOSION_CHAIN_DELAY) + 500);
        }

        function resume() { if (isGameOver || isTransitioningLevel) return; showTemporaryMessage("", ""); isGamePaused = false; gameLoop(); }

        async function endGame() {
            isGameOver = true; isGamePaused = true; triggerHaptic([200, 100, 200]);
            if (animationFrameHandle) cancelAnimationFrame(animationFrameHandle);
            if (score > (worldRecords[currentThemeId] || 0)) showInitialsEntry();
            else finishEndGame();
        }

        function showInitialsEntry() {
            const overlay = document.getElementById('overlay');
            const btns = document.getElementById('difficulty-buttons');
            overlay.classList.remove('hidden');
            btns.innerHTML = `<div class="flex flex-col items-center">
                <p class="text-xl text-green-400 font-bold mb-4 uppercase">New Record!</p>
                <input type="text" id="initials-field" maxlength="3" class="initials-input" placeholder="---" autofocus>
                <button id="submit-initials" class="bg-red-600 text-white font-black py-4 px-12 rounded shadow-2xl uppercase">Register</button>
            </div>`;
            document.getElementById('status-message').innerHTML = `<p class="text-5xl font-black text-white italic mb-4">ENTER INITIALS</p>`;
            document.getElementById('submit-initials').onclick = async (e) => {
                e.stopPropagation(); const initials = (document.getElementById('initials-field').value || '???').toUpperCase().substring(0,3);
                await saveWorldRecord(currentThemeId, score, level, initials); finishEndGame();
            };
        }

        function finishEndGame() {
            document.getElementById('game-area').classList.remove('hide-pointer');
            document.getElementById('header-stats-play').classList.add('hidden');
            document.getElementById('header-stats-menu').classList.remove('hidden');
            startHighscoreTicker(); showThemeSelection(true);
        }

        function createExplosion(centerX, centerY) {
            const el = document.createElement('img');
            el.src = THEMES[currentThemeId].graphics.EXPLOSION + "?t=" + Date.now();
            el.className = 'explosion-img pixel-art';
            el.style.width = `${THEMES[currentThemeId].explosionDim.w}px`; el.style.height = `${THEMES[currentThemeId].explosionDim.h}px`;
            el.style.left = `${centerX - THEMES[currentThemeId].explosionDim.w / 2}px`; el.style.top = `${centerY - THEMES[currentThemeId].explosionDim.h / 2}px`;
            document.getElementById('game-area').appendChild(el); setTimeout(() => el.remove(), THEMES[currentThemeId].missDuration);
        }

        function createSplash(centerX, hitboxTopY) {
            const el = document.createElement('img');
            el.src = THEMES[currentThemeId].graphics.SPLASH + "?t=" + Date.now();
            el.className = 'splash-img pixel-art';
            el.style.width = `${THEMES[currentThemeId].splashDim.w}px`; el.style.height = `${THEMES[currentThemeId].splashDim.h}px`;
            el.style.left = `${centerX - THEMES[currentThemeId].splashDim.w / 2}px`; el.style.top = `${hitboxTopY - THEMES[currentThemeId].splashDim.h}px`;
            document.getElementById('game-area').appendChild(el); setTimeout(() => el.remove(), THEMES[currentThemeId].catchDuration);
        }

        function updateScoreDisplay() {
            const scoreStr = score.toString().padStart(6, '0');
            document.getElementById('score-display').textContent = scoreStr;
            const hiLabel = document.getElementById('hi-label');
            const hiInitialsEl = document.getElementById('hi-initials');
            const hiDisplay = document.getElementById('highscore-display');
            const hiMeta = document.getElementById('hi-meta-row');
            const record = worldRecords[currentThemeId] || 0;
            
            if (!isGameOver) {
                hiLabel.textContent = "World Best"; hiMeta.classList.add('hidden');
                if (score > record) {
                    hiInitialsEl.textContent = "YOU"; hiDisplay.textContent = scoreStr;
                    hiInitialsEl.className = hiDisplay.className = "text-red-500 font-black text-sm tracking-tight leading-none";
                } else {
                    hiInitialsEl.textContent = worldInitials[currentThemeId] || '---'; hiDisplay.textContent = record.toString().padStart(6, '0');
                    hiInitialsEl.className = "text-gray-400 font-bold text-[10px] tracking-tighter mr-1";
                    hiDisplay.className = "text-yellow-400 font-bold text-sm tracking-tight leading-none";
                }
            } else {
                hiLabel.textContent = "Catch King"; hiMeta.classList.remove('hidden');
                const bestId = Object.keys(worldRecords).reduce((a, b) => worldRecords[a] > worldRecords[b] ? a : b, 'classic');
                hiInitialsEl.textContent = worldInitials[bestId] || '---';
                hiDisplay.textContent = (worldRecords[bestId] || 0).toString().padStart(6, '0');
                hiInitialsEl.className = "text-gray-400 font-bold text-[10px] tracking-tighter mr-1";
                hiDisplay.className = "text-yellow-400 font-bold text-base tracking-tight leading-none text-shadow-glow";
                document.getElementById('hi-theme-name').textContent = THEMES[bestId].title;
                document.getElementById('hi-level-name').textContent = `L${worldLevels[bestId] || 1}`;
            }
            document.getElementById('level-display').textContent = `S${level.toString().padStart(2, '0')}`;
            document.getElementById('lives-count').textContent = `Ã—${lives}`;
            const stack = document.getElementById('buckets-stack');
            const theme = THEMES[currentThemeId];
            if (theme.isStacked) {
                const h = lives * (theme.bucketDim.h + theme.bucketDim.gap);
                stack.style.height = `${h}px`; stack.style.top = `${GAME_AREA_HEIGHT - h}px`;
                bucketElements.forEach((el, idx) => el.style.display = idx < lives ? 'block' : 'none');
            } else {
                stack.style.height = `${theme.bucketDim.h}px`; stack.style.top = `${GAME_AREA_HEIGHT - theme.bucketDim.h}px`;
                const img = document.getElementById('single-catcher-img'); if (img) img.src = theme.graphics.BUCKET_LAYERS[lives];
            }
        }

        function showThemeSelection(isOver = false) {
            const overlay = document.getElementById('overlay');
            overlay.classList.remove('hidden'); overlay.style.opacity = 1;
            const btns = document.getElementById('difficulty-buttons'); btns.innerHTML = '';
            if (isOver) document.getElementById('status-message').innerHTML = `<p class="text-4xl font-extrabold text-red-500 mb-4 uppercase italic text-center">Game Over</p><p class="text-xl mb-2 text-gray-300 text-center">Score: ${score.toString().padStart(6, '0')}</p><p class="text-lg mb-8 text-gray-400 font-mono text-sm text-center">Stage ${level}</p>`;
            else document.getElementById('status-message').innerHTML = `<p class="text-5xl font-black text-yellow-400 mb-4 uppercase tracking-tighter italic text-center">Kaboom!</p><p class="text-xl mb-8 text-gray-300 font-medium text-center">Select Version</p>`;
            Object.keys(THEMES).forEach(id => {
                const b = document.createElement('button'); b.textContent = THEMES[id].title;
                b.className = 'bg-indigo-600 text-white font-extrabold py-4 px-8 rounded-lg m-2 uppercase hover:scale-105 active:bg-indigo-800 pointer-events-auto';
                b.onclick = (e) => { e.stopPropagation(); triggerHaptic(10); showDifficultySelection(id); };
                btns.appendChild(b);
            });
        }

        function showDifficultySelection(themeId) {
            const btns = document.getElementById('difficulty-buttons');
            document.getElementById('status-message').innerHTML = `<p class="text-3xl font-bold text-yellow-400 mb-2 uppercase italic text-center">${THEMES[themeId].title}</p><p class="text-gray-400 mb-8 max-w-xs mx-auto text-sm text-center">${THEMES[themeId].description}</p>`;
            btns.innerHTML = '';
            ['EASY', 'MEDIUM', 'HARD'].forEach(l => {
                const b = document.createElement('button'); b.textContent = l;
                const colors = { EASY: 'bg-green-600', MEDIUM: 'bg-yellow-600', HARD: 'bg-red-600' };
                b.className = `${colors[l]} text-white font-extrabold py-3 px-8 rounded-full m-2 uppercase hover:scale-105 active:opacity-80 pointer-events-auto w-32`;
                b.onclick = (e) => { e.stopPropagation(); triggerHaptic(20); startGame(themeId, l); };
                btns.appendChild(b);
            });
            const back = document.createElement('button'); back.textContent = 'Back';
            back.className = 'bg-gray-700 text-white font-bold py-2 px-4 rounded-full mt-8 block mx-auto text-xs pointer-events-auto';
            back.onclick = (e) => { e.stopPropagation(); triggerHaptic(5); showThemeSelection(); };
            btns.appendChild(back);
        }

        function handleInteraction(e) {
            if (isGameOver && !document.getElementById('initials-field')) return;
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const rect = document.getElementById('game-area').getBoundingClientRect();
            const imageLeft = (clientX - rect.left) - (getCurrentHitbox().xOffset + getCurrentHitbox().catchW / 2);
            bucketX = Math.max(0 - getCurrentHitbox().xOffset, Math.min(imageLeft, GAME_AREA_WIDTH - (getCurrentHitbox().xOffset + getCurrentHitbox().catchW)));
            document.getElementById('buckets-stack').style.left = `${bucketX}px`;
            if (e.type === 'touchstart' || e.type === 'mousedown') {
                const now = Date.now();
                if (isGamePaused && !isGameOver && !document.getElementById('initials-field')) resume();
                else if (now - lastTapTime < 300) togglePauseGesture();
                lastTapTime = now;
            }
        }

        function togglePauseGesture() {
            if (isGameOver || isTransitioningLevel) return;
            isGamePaused = !isGamePaused; triggerHaptic(15);
            if (isGamePaused) showTemporaryMessage("PAUSED", "text-blue-400");
            else { showTemporaryMessage("GO!", "text-green-400"); gameLoop(); }
        }

        function showTemporaryMessage(text, color) {
            const el = document.getElementById('temp-message'); el.textContent = text;
            if (text === "") { el.style.opacity = 0; return; }
            el.className = `absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-4xl font-black p-3 rounded-lg z-20 transition-opacity duration-300 ${color} shadow-2xl text-center uppercase italic`;
            el.style.opacity = 1; if (text === "OOPS!" || text === "GO!" || text === "LEVEL COMPLETE!" || text.startsWith("LEVEL ")) setTimeout(() => el.style.opacity = 0, 1500);
        }

        window.onload = () => { initFirebase(); showThemeSelection(); startHighscoreTicker();
            const area = document.getElementById('game-area');
            area.addEventListener('mousemove', handleInteraction);
            area.addEventListener('mousedown', handleInteraction);
            area.addEventListener('touchstart', (e) => { if (!isGameOver) e.preventDefault(); handleInteraction(e); }, { passive: false });
            area.addEventListener('touchmove', (e) => { if (!isGameOver) e.preventDefault(); handleInteraction(e); }, { passive: false });
        };
    </script>
</head>
<body class="flex flex-col items-center justify-start min-h-screen p-2 pt-4">
    <div id="preload-cache"></div>
    <div id="game-container" class="w-full flex flex-col items-center">
        <!-- ARCADE HUD -->
        <div class="w-full max-w-[400px] bg-gradient-to-b from-gray-800 to-black rounded-t-lg shadow-2xl border-b-4 border-yellow-500 font-mono overflow-hidden">
            <div class="flex justify-between px-4 pt-1">
                <span id="hi-label" class="text-[8px] text-gray-500 font-bold uppercase tracking-widest">Catch King</span>
                <span id="center-label" class="text-[8px] text-gray-500 font-bold uppercase tracking-widest">Stage</span>
                <span class="text-[8px] text-gray-500 font-bold uppercase tracking-widest">1UP Score</span>
            </div>
            <div class="flex justify-between items-center px-4 pb-2">
                <div id="hi-score-container" class="flex flex-col min-w-[120px]">
                    <div class="flex items-baseline">
                        <span id="hi-initials" class="text-gray-400 font-bold text-[10px] tracking-tighter mr-1">---</span>
                        <span id="highscore-display" class="text-yellow-400 font-bold text-base tracking-tight leading-none">000000</span>
                    </div>
                    <div id="hi-meta-row" class="text-[7px] text-gray-500 leading-none mt-0.5 uppercase flex gap-1">
                        <span id="hi-theme-name">Classic</span> â€¢ <span id="hi-level-name">L1</span>
                    </div>
                </div>
                <div id="center-header-area" class="flex-1 flex justify-center items-center px-2">
                    <div id="header-stats-play" class="hidden flex items-center gap-4">
                        <span id="level-display" class="text-white font-black text-base leading-none">S01</span>
                        <div class="flex items-center bg-gray-900 border border-gray-700 px-2 py-0.5 rounded shadow-inner">
                            <img id="life-icon" src="" class="w-4 h-3 object-contain mr-1 pixel-art" alt="Life">
                            <span id="lives-count" class="text-yellow-400 font-bold text-xs leading-none">Ã—3</span>
                        </div>
                    </div>
                    <div id="header-stats-menu" class="ticker-container w-full">
                        <div id="ticker-inner" class="ticker-item">
                            <span id="ticker-theme-name" class="text-[7px] text-gray-500 font-bold uppercase tracking-tighter leading-none mb-1 text-center">---</span>
                            <span id="ticker-theme-score" class="text-white font-bold text-[11px] leading-none text-center">--- - 000000 L1</span>
                        </div>
                    </div>
                </div>
                <div id="score-display" class="text-green-400 font-black text-xl tracking-widest min-w-[100px] text-right leading-none">000000</div>
            </div>
        </div>

        <div id="game-area" class="w-full h-[600px] max-w-[400px] rounded-b-lg relative shadow-2xl overflow-hidden border-x-2 border-b-2 border-gray-800">
            <div id="mad-bomber-img" class="mad-bomber-img" style="display: none;"></div>
            <div id="buckets-stack" class="bucket-stack"></div>
            <div id="temp-message" class="transition-opacity duration-300 opacity-0 pointer-events-none text-center"></div>
            <div id="overlay" class="game-status-overlay">
                <div class="text-center p-6">
                    <div id="status-message" class="mb-8"></div>
                    <div id="difficulty-buttons" class="flex flex-wrap justify-center items-center"></div>
                </div>
            </div>
        </div>
    </div>
    <div class="mt-4 text-[9px] text-gray-700 font-mono flex flex-col gap-1 items-center uppercase tracking-widest text-center">
        <p>Double-Tap to Pause â€¢ Single Tap to Resume</p>
        <span>Player ID: <span id="user-id-display">Connecting...</span></span>
    </div>
</body>
</html>
